angular.module("pym.fs",[]),angular.module("pym.fs").constant("FILE_STATES",{NEW:0,VALIDATING:10,VALIDATION_OK:20,VALIDATION_ERROR:-20,UPLOADING:30,UPLOAD_OK:40,UPLOAD_ERROR:-40,UPLOAD_CANCELED:-100}).constant("FILE_STATE_CAPTIONS",{0:"New (0)",10:"Validating (10)",20:"Validation OK (20)","-20":"Validation Error (-20)",30:"Uploading (30)",40:"Upload OK (40)","-40":"Upload Error (-40)","-100":"Upload Canceled (-100)"}),angular.module("pym.fs").factory("pymFsService",["$log","$http","$window","RC",function(t,e,a,r){"use strict";var n={tree:null,browser:null,rootPathStr:"",path:[],overwrite:!1,includeDeleted:!1,getPath:function(){return this.path},getPathStr:function(){return this.pathToStr(this.path)},setPath:function(t){this.path=t,this.tree.setPath(t),this.browser.setPath(t)},getLeafNode:function(){return this.path[this.path.length-1]},toggleIncludeDeleted:function(){var t=this.path,e=t[0];if(this.includeDeleted=!this.includeDeleted,this.getLeafNode().is_deleted&&!this.includeDeleted){for(;t.length&&t[t.length-1].is_deleted;)t.pop();t.length||t.push(e),this.setPath(t)}else this.tree.refresh(),this.browser.refresh()},firstLoad:function(e){var a=this;this.rootPathStr=e,t.log("firstLoad",this.pathToStr(this.path),this.rootPathStr),this.browser.loadItems(),this.tree.initNodes().then(function(){a.path=a.tree.path,a.browser.path=a.path})},createDirectory:function(t){var a={},n={name:t,path:this.pathToStr(this.path)};return e.post(r.urls.create_directory,n,a).then(function(t){return t.data.ok,PYM.growl_ajax_resp(t.data),t},function(t){return t})},deleteItems:function(t,a){var n={params:{path:this.pathToStr(this.path),names:t,reason:a}};return e["delete"](r.urls.delete_items,n).then(function(t){return t.data.ok,PYM.growl_ajax_resp(t.data),t},function(t){return t})},undeleteItems:function(t){var a={},n={path:this.pathToStr(this.path),names:t};return e.put(r.urls.undelete_items,n,a).then(function(t){return t.data.ok,PYM.growl_ajax_resp(t.data),t},function(t){return t})},loadItems:function(){var t={params:{path:this.pathToStr(this.path)||this.rootPathStr,incdel:this.includeDeleted}};return e.get(r.urls.load_items,t).then(function(t){return t.data.ok||PYM.growl_ajax_resp(t.data),t},function(t){return t})},loadTree:function(t){var a={params:{path:this.rootPathStr,filter:t,incdel:this.includeDeleted}};return e.get(r.urls.load_tree,a).then(function(t){return t.data.ok||PYM.growl_ajax_resp(t.data),t},function(t){return t})},loadFsProperties:function(){var t={params:{}};return e.get(r.urls.load_fs_properties,t).then(function(t){return t.data.ok?t:(PYM.growl_ajax_resp(t.data),!1)},function(t){return t})},loadItemProperties:function(t){var a={params:{path:this.pathToStr(this.path),name:t}};return e.get(r.urls.load_item_properties,a).then(function(t){return t.data.ok?t:(PYM.growl_ajax_resp(t.data),!1)},function(t){return t})},buildDownloadUrl:function(t){var e,r;return e=this.path.slice(),"fs"===e[0].name&&e.shift(),r=e.length?this.pathToStr(e)+"/"+t:t,a.location.href.replace(/@@_br_/,r)},pathToStr:function(t){if(!(angular.isArray(t)&&t.length>0))return null;var e=[];return angular.forEach(t,function(t){e.push(t.name)}),e.join("/")}};return n}]),angular.module("pym.fs").factory("pymFsUploaderService",["$log","$upload","$http","RC","FILE_STATES","FILE_STATE_CAPTIONS",function(t,e,a,r,n,i){"use strict";function s(t){this.file=t,this.state=0,this.stateCaption=null,this.key=null,this.progress=0,this.validationPromise=null,this.validationMessage=null,this.uploadPromise=null,this.isActive=!1,this.isUploading=!1,this.hasError=!1}s.prototype.setState=function(e){this.state=e,this.stateCaption=i[e],this.isActive=this.state>n.NEW&&this.state<n.UPLOAD_OK,this.isUploading=this.state===n.UPLOADING,this.hasError=this.state>n.UPLOAD_CANCELED&&this.state<n.NEW,t.log("state",e,this.stateCaption,this)},s.prototype.abort=function(){this.uploadPromise&&this.uploadPromise.abort(),this.setState(n.UPLOAD_CANCELED)};var o={createPymFile:function(t){return new s(t)},upload:function(t,a,i){var s,o={url:r.urls.upload,file:a.file,data:{path:t,overwrite:i}};return s=e.upload(o).error(function(t){a.setState(n.UPLOAD_ERROR),a.validationMessage=t}),a.uploadPromise=s,a.setState(n.UPLOADING),s},validateFiles:function(e,i,s){var o={},l={},u=[];return t.log("fileList to validate",i),angular.forEach(i,function(t){t.state===n.VALIDATING&&u.push({key:t.key,name:t.file.name,size:t.file.size,mime_type:t.file.type})}),l.path=e,l.files=u,l.overwrite=s,a.post(r.urls.validate_files,l,o).then(function(t){return t.data.ok?angular.forEach(t.data.data,function(t,e){"ok"===t?i[e].setState(n.VALIDATION_OK):(i[e].setState(n.VALIDATION_ERROR),i[e].validationMessage=t)}):(PYM.growl_ajax_resp(t.data),angular.forEach(i,function(t,e){t.state===n.VALIDATING&&(i[e].setState(n.VALIDATION_ERROR),i[e].validationMessage="Unknown error")})),t},function(t){return angular.forEach(i,function(t,e){t.state===n.VALIDATING&&(i[e].setState(n.VALIDATION_ERROR),i[e].validationMessage="Network error")}),t})}};return o}]),angular.module("pym.fs").controller("pymFsUploaderController",["$scope","$window","$log","T","pymFsService","pymFsUploaderService","FILE_STATES",function(t,e,a,r,n,i,s){"use strict";function o(){var t,e;for(t=0;10>t;t++)e=new i.createPymFile({name:"dfdsffs sdfsgdfg fgsfgfdg sdfgfdg sdfgs dfg sdfg dfgsdfdg sdfgdfgs dfg d dsdgfsfdsg",size:6523856653,type:"stuff/sample"}),e.setState(t%2===0?s.UPLOAD_ERROR:s.VALIDATION_OK),e.validationMessage="blah bÃ¶lddf erwe",l.queue[t]=e;l.windowIsOpen=!0}var l=this;l.files=[],l.rejectedFiles=[],l.isDropAvailable=null,l.queue={},l.activeUploads=0,l.errors=0,l.uploading=0,l.totalProgress=0,l.windowMaximized=!0,l.windowIsOpen=!1,l.countActiveUploads=function(){var t=0,e=0,a=0,r=0,n=0;angular.forEach(l.queue,function(i){i.isActive&&++t,i.hasError&&++e,i.isUploading&&++a,r+=i.progress,++n}),l.activeUploads=t,l.errors=e,l.uploading=a,0!==n&&(l.totalProgress=parseInt(r/n))},t.$watch(l.countActiveUploads,function(){angular.noop()}),l.minimaxWindow=function(){l.windowMaximized=!l.windowMaximized},l.closeWindow=function(){var t;if(!l.activeUploads||l.cancelAll()){for(t in l.queue)l.queue.hasOwnProperty(t)&&delete l.queue[t];l.windowIsOpen=!1}},l.fileDropped=function(t,e){a.log("dropped",t,this.files,e),t&&t.length>0&&this.enqueue(t)},l.fileSelected=function(t,e){a.log("selected",t,this.files,e),t&&t.length>0&&this.enqueue(t)},l.validate=function(t){return a.log("Validating file",t),"audio/x-ape"!==t.type},l.enqueue=function(t){var e,a,r,o=this,u={};if(t&&t.length>0){for(l.windowIsOpen=!0,e=0,a=t.length;a>e;e++)r=new i.createPymFile(t[e]),o.queue[t[e].name]?(r.setState(s.VALIDATION_ERROR),r.validationMessage="File with this name already in queue",r.key=r.file.name+new Date):(r.setState(s.VALIDATING),o.validateHere(r),r.key=r.file.name),u[r.key]=r,o.queue[r.key]=r;i.validateFiles(n.getPathStr(),u)}},l.validateHere=function(){},l.cbProgress=function(t){var e=parseInt(100*t.loaded/t.total);this.progress=e},l.cbSuccess=function(){this.setState(s.UPLOAD_OK)},l.startUpload=function(){var t,e,r,o=this;angular.forEach(o.queue,function(l){l.state===s.VALIDATION_OK&&(a.log("starting upload of",l.file.name,l),e=angular.bind(l,o.cbProgress),r=angular.bind(l,o.cbSuccess),t=i.upload(n.getPathStr(),l,n.overwrite).progress(e).success(r))})},l.cancel=function(t){t.abort()},l.cancelAll=function(){return l.activeUploads&&!e.confirm(r.confirm_cancel_all_uploads)?!1:(angular.forEach(l.queue,function(t){t.abort()}),!0)},l.checkType=function(t){var e,r,n,i,s=this;for(t||(t="application/octet-stream"),t=t.split("/"),a.log(t),i=!1,e=0,r=s.allow.length;r>e;e++)if(n=s.allow[e],n.search(/\*/)>-1&&-1===n.search(/\.\*/)&&(n=n.replace(/\*/g,".*")),n=n.split("/"),t[0].search(n[0])>-1&&t[1].search(n[1])>-1){i=!0;break}if(!i)return!1;for(e=0,r=s.deny.length;r>e;e++)if(n=s.deny[e],n.search(/\*/)>-1&&-1===n.search(/\.\*/)&&(n=n.replace(/\*/g,".*")),n=n.split("/"),t[0].search(n[0])>-1||t[1].search(n[1])>-1){i=!1;break}return i},l.checkSize=function(t){return t>=this.minSize&&t<=this.maxSize},o()}]);