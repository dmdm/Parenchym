angular.module("pym.fs",[]),angular.module("pym.fs").constant("FILE_STATES",{NEW:0,VALIDATING:10,VALIDATION_OK:20,VALIDATION_ERROR:-20,CAN_UPLOAD:70,UPLOADING:80,UPLOAD_OK:90,UPLOAD_ERROR:-90,UPLOAD_CANCELED:-100}).constant("FILE_STATE_CAPTIONS",{0:"New (0)",10:"Validating (10)",20:"Validation OK (20)","-20":"Validation Error (-20)",70:"Can Upload (70)",80:"Uploading (80)",90:"Upload OK (90)","-90":"Upload Error (-90)","-100":"Upload Canceled (-100)"}),angular.module("pym.fs").factory("pymFsService",["$log","$http","$window","RC","pymService",function(t,e,a,r){"use strict";var i={tree:null,browser:null,rootPathStr:"",path:[],overwrite:!1,includeDeleted:!1,getPath:function(){return this.path},getPathStr:function(){return this.pathToStr(this.path)},setPath:function(t){this.path=t,this.tree.setPath(t),this.browser.setPath(t)},getLeafNode:function(){return this.path[this.path.length-1]},toggleIncludeDeleted:function(){var t=this.path,e=t[0];if(this.includeDeleted=!this.includeDeleted,this.getLeafNode().is_deleted&&!this.includeDeleted){for(;t.length&&t[t.length-1].is_deleted;)t.pop();t.length||t.push(e),this.setPath(t)}else this.tree.refresh(),this.browser.refresh()},firstLoad:function(e){var a=this;this.rootPathStr=e,t.log("firstLoad",this.pathToStr(this.path),this.rootPathStr),this.browser.loadItems(),this.tree.initNodes().then(function(){a.path=a.tree.path,a.browser.path=a.path})},createDirectory:function(t){var a={},i={name:t,path:this.pathToStr(this.path)};return e.post(r.urls.create_directory,i,a).then(function(t){return t.data.ok,Pym.growler.growlAjaxResp(t.data),t},function(t){return t})},deleteItems:function(t,a){var i={params:{path:this.pathToStr(this.path),names:t,reason:a}};return e["delete"](r.urls.delete_items,i).then(function(t){return t.data.ok,Pym.growler.growlAjaxResp(t.data),t},function(t){return t})},undeleteItems:function(t){var a={},i={path:this.pathToStr(this.path),names:t};return e.put(r.urls.undelete_items,i,a).then(function(t){return t.data.ok,Pym.growler.growlAjaxResp(t.data),t},function(t){return t})},loadItems:function(){var t={params:{path:this.pathToStr(this.path)||this.rootPathStr,incdel:this.includeDeleted}};return e.get(r.urls.load_items,t).then(function(t){return t.data.ok||Pym.growler.growlAjaxResp(t.data),t},function(t){return t})},loadTree:function(t){var a={params:{path:this.rootPathStr,filter:t,incdel:this.includeDeleted}};return e.get(r.urls.load_tree,a).then(function(t){return t.data.ok||Pym.growler.growlAjaxResp(t.data),t},function(t){return t})},loadFsProperties:function(){var t={params:{}};return e.get(r.urls.load_fs_properties,t).then(function(t){return t.data.ok?t:(Pym.growler.growlAjaxResp(t.data),!1)},function(t){return t})},loadItemProperties:function(t){var a={params:{path:this.pathToStr(this.path),name:t}};return e.get(r.urls.load_item_properties,a).then(function(t){return t.data.ok?t:(Pym.growler.growlAjaxResp(t.data),!1)},function(t){return t})},buildDownloadUrl:function(t){var e,r;return e=this.path.slice(),"fs"===e[0].name&&e.shift(),r=e.length?this.pathToStr(e)+"/"+t:t,a.location.href.replace(/@@_br_/,r)},pathToStr:function(t){if(!(angular.isArray(t)&&t.length>0))return null;var e=[];return angular.forEach(t,function(t){e.push(t.name)}),e.join("/")}};return i}]),angular.module("pym.fs").factory("pymFsUploaderService",["$log","$upload","$http","RC","pymService","FILE_STATES","FILE_STATE_CAPTIONS",function(t,e,a,r,i,n,s){"use strict";function o(t){this.file=t,this.state=0,this.stateCaption=null,this.key=null,this.progress=0,this.validationPromise=null,this.validationMessage=null,this.uploadPromise=null,this.isActive=!1,this.isUploading=!1,this.hasError=!1,this.exists=!1,this.permissions=null,this.writeMode=null}o.prototype.setState=function(e){this.state=e,this.stateCaption=s[e],this.isActive=this.state>n.NEW&&this.state<n.UPLOAD_OK,this.isUploading=this.state===n.UPLOADING,this.hasError=this.state>n.UPLOAD_CANCELED&&this.state<n.NEW,t.log("state",e,this.stateCaption,this)},o.prototype.setWriteMode=function(t){this.writeMode=t,this.setState(n.CAN_UPLOAD)},o.prototype.abort=function(){this.uploadPromise&&this.uploadPromise.abort(),this.setState(n.UPLOAD_CANCELED)};var l={createPymFile:function(t){return new o(t)},upload:function(t,a){var i,s={url:r.urls.upload,file:a.file,data:{path:t,write_mode:a.writeMode},headers:{"content-type":a.file.type}};return i=e.upload(s).error(function(t){a.setState(n.UPLOAD_ERROR),a.validationMessage=t}),a.uploadPromise=i,a.setState(n.UPLOADING),i},validateFiles:function(e,s){var o={},l={},u=[];return t.log("fileList to validate",s),angular.forEach(s,function(t){t.state===n.VALIDATING&&u.push({key:t.key,filename:t.file.name,size:t.file.size,mime_type:t.file.type})}),l.path=e,l.files=u,a.post(r.urls.validate_files,l,o).then(function(t){return t.data.ok?angular.forEach(t.data.data,function(t,e){t.ok?(s[e].exists=t.exists,s[e].permissions=t.permissions,s[e].setState(!t.exists&&t.permissions.create?n.CAN_UPLOAD:n.VALIDATION_OK)):(s[e].setState(n.VALIDATION_ERROR),s[e].validationMessage=t.validation_msg)}):(i.growler.growlAjaxResp(t.data),angular.forEach(s,function(t,e){t.state===n.VALIDATING&&(s[e].setState(n.VALIDATION_ERROR),s[e].validationMessage="Unknown error")})),t},function(t){return angular.forEach(s,function(t,e){t.state===n.VALIDATING&&(s[e].setState(n.VALIDATION_ERROR),s[e].validationMessage="Network error")}),t})}};return l}]),angular.module("pym.fs").controller("pymFsUploaderController",["$scope","$window","$log","T","pymService","pymFsService","pymFsUploaderService","FILE_STATES","$q",function(t,e,a,r,i,n,s,o,l){"use strict";function u(){var t,e;for(t=0;10>t;t++)e=new s.createPymFile({name:"dfdsffs sdfsgdfg fgsfgfdg sdfgfdg sdfgs dfg sdfg dfgsdfdg sdfgdfgs dfg d dsdgfsfdsg",size:6523856653,type:"stuff/sample"}),e.setState(t%2===0?o.UPLOAD_ERROR:o.CAN_UPLOAD),e.validationMessage="blah bÃ¶lddf erwe",h.queue[t]=e;h.windowIsOpen=!0}var h=this;h.FILE_STATES=o,h.files=[],h.rejectedFiles=[],h.isDropAvailable=null,h.queue={},h.activeUploads=0,h.errors=0,h.uploading=0,h.totalProgress=0,h.windowMaximized=!0,h.windowIsOpen=!1,h.countActiveUploads=function(){var t=0,e=0,a=0,r=0,i=0;angular.forEach(h.queue,function(n){n.isActive&&++t,n.hasError&&++e,n.isUploading&&++a,r+=n.progress,++i}),h.activeUploads=t,h.errors=e,h.uploading=a,0!==i&&(h.totalProgress=parseInt(r/i))},t.$watch(h.countActiveUploads,function(){angular.noop()}),h.minimaxWindow=function(){h.windowMaximized=!h.windowMaximized},h.cancelAll=function(){return h.activeUploads?i.growler.confirm(r.confirm_cancel_all_uploads).then(function(){angular.forEach(h.queue,function(t){t.abort()})}):l.defer().resolve()},h.closeWindow=function(){function t(){h.clearQueue(),h.windowIsOpen=!1}h.activeUploads?h.cancelAll().then(t):t()},h.fileDropped=function(t,e){a.log("dropped",t,this.files,e),t&&t.length>0&&this.enqueue(t)},h.fileSelected=function(t,e){a.log("selected",t,this.files,e),t&&t.length>0&&this.enqueue(t)},h.validate=function(t){return a.log("Validating file",t),"audio/x-ape"!==t.type},h.clearQueue=function(){var t;for(t in h.queue)h.queue.hasOwnProperty(t)&&delete h.queue[t]},h.enqueue=function(t){var e,a,r,i=this,l={};if(t&&t.length>0){for(h.windowIsOpen=!0,e=0,a=t.length;a>e;e++)r=new s.createPymFile(t[e]),i.queue[t[e].name]?(r.setState(o.VALIDATION_ERROR),r.validationMessage="File with this name already in queue",r.key=r.file.name+new Date):(r.setState(o.VALIDATING),i.validateHere(r),r.key=r.file.name),l[r.key]=r,i.queue[r.key]=r;s.validateFiles(n.getPathStr(),l)}},h.validateHere=function(){},h.cbProgress=function(t){var e=parseInt(100*t.loaded/t.total);this.progress=e},h.cbSuccess=function(){this.setState(o.UPLOAD_OK)},h.startUpload=function(){var t,e,r,i=this;angular.forEach(i.queue,function(l){l.state===o.CAN_UPLOAD&&(a.log("starting upload of",l.file.name,l),e=angular.bind(l,i.cbProgress),r=angular.bind(l,i.cbSuccess),t=s.upload(n.getPathStr(),l).progress(e).success(r))})},h.cancel=function(t){t.abort()},h.checkType=function(t){var e,r,i,n,s=this;for(t||(t="application/octet-stream"),t=t.split("/"),a.log(t),n=!1,e=0,r=s.allow.length;r>e;e++)if(i=s.allow[e],i.search(/\*/)>-1&&-1===i.search(/\.\*/)&&(i=i.replace(/\*/g,".*")),i=i.split("/"),t[0].search(i[0])>-1&&t[1].search(i[1])>-1){n=!0;break}if(!n)return!1;for(e=0,r=s.deny.length;r>e;e++)if(i=s.deny[e],i.search(/\*/)>-1&&-1===i.search(/\.\*/)&&(i=i.replace(/\*/g,".*")),i=i.split("/"),t[0].search(i[0])>-1||t[1].search(i[1])>-1){n=!1;break}return n},h.checkSize=function(t){return t>=this.minSize&&t<=this.maxSize},u()}]);