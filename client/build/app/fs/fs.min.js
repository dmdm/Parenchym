angular.module("pym.fs",[]),angular.module("pym.fs").constant("FILE_STATES",{NEW:0,VALIDATING:10,VALIDATION_OK:20,VALIDATION_ERROR:-20,UPLOADING:30,UPLOAD_OK:40,UPLOAD_ERROR:-40,UPLOAD_CANCELED:-100}).constant("FILE_STATE_CAPTIONS",{0:"New (0)",10:"Validating (10)",20:"Validation OK (20)","-20":"Validation Error (-20)",30:"Uploading (30)",40:"Upload OK (40)","-40":"Upload Error (-40)","-100":"Upload Canceled (-100)"}),angular.module("pym.fs").factory("pymFsService",["$log","$http","$window","RC","pymService",function(t,e,a,r){"use strict";var n={tree:null,browser:null,rootPathStr:"",path:[],overwrite:!1,includeDeleted:!1,getPath:function(){return this.path},getPathStr:function(){return this.pathToStr(this.path)},setPath:function(t){this.path=t,this.tree.setPath(t),this.browser.setPath(t)},getLeafNode:function(){return this.path[this.path.length-1]},toggleIncludeDeleted:function(){var t=this.path,e=t[0];if(this.includeDeleted=!this.includeDeleted,this.getLeafNode().is_deleted&&!this.includeDeleted){for(;t.length&&t[t.length-1].is_deleted;)t.pop();t.length||t.push(e),this.setPath(t)}else this.tree.refresh(),this.browser.refresh()},firstLoad:function(e){var a=this;this.rootPathStr=e,t.log("firstLoad",this.pathToStr(this.path),this.rootPathStr),this.browser.loadItems(),this.tree.initNodes().then(function(){a.path=a.tree.path,a.browser.path=a.path})},createDirectory:function(t){var a={},n={name:t,path:this.pathToStr(this.path)};return e.post(r.urls.create_directory,n,a).then(function(t){return t.data.ok,Pym.growler.growlAjaxResp(t.data),t},function(t){return t})},deleteItems:function(t,a){var n={params:{path:this.pathToStr(this.path),names:t,reason:a}};return e["delete"](r.urls.delete_items,n).then(function(t){return t.data.ok,Pym.growler.growlAjaxResp(t.data),t},function(t){return t})},undeleteItems:function(t){var a={},n={path:this.pathToStr(this.path),names:t};return e.put(r.urls.undelete_items,n,a).then(function(t){return t.data.ok,Pym.growler.growlAjaxResp(t.data),t},function(t){return t})},loadItems:function(){var t={params:{path:this.pathToStr(this.path)||this.rootPathStr,incdel:this.includeDeleted}};return e.get(r.urls.load_items,t).then(function(t){return t.data.ok||Pym.growler.growlAjaxResp(t.data),t},function(t){return t})},loadTree:function(t){var a={params:{path:this.rootPathStr,filter:t,incdel:this.includeDeleted}};return e.get(r.urls.load_tree,a).then(function(t){return t.data.ok||Pym.growler.growlAjaxResp(t.data),t},function(t){return t})},loadFsProperties:function(){var t={params:{}};return e.get(r.urls.load_fs_properties,t).then(function(t){return t.data.ok?t:(Pym.growler.growlAjaxResp(t.data),!1)},function(t){return t})},loadItemProperties:function(t){var a={params:{path:this.pathToStr(this.path),name:t}};return e.get(r.urls.load_item_properties,a).then(function(t){return t.data.ok?t:(Pym.growler.growlAjaxResp(t.data),!1)},function(t){return t})},buildDownloadUrl:function(t){var e,r;return e=this.path.slice(),"fs"===e[0].name&&e.shift(),r=e.length?this.pathToStr(e)+"/"+t:t,a.location.href.replace(/@@_br_/,r)},pathToStr:function(t){if(!(angular.isArray(t)&&t.length>0))return null;var e=[];return angular.forEach(t,function(t){e.push(t.name)}),e.join("/")}};return n}]),angular.module("pym.fs").factory("pymFsUploaderService",["$log","$upload","$http","RC","pymService","FILE_STATES","FILE_STATE_CAPTIONS",function(t,e,a,r,n,i,o){"use strict";function s(t){this.file=t,this.state=0,this.stateCaption=null,this.key=null,this.progress=0,this.validationPromise=null,this.validationMessage=null,this.uploadPromise=null,this.isActive=!1,this.isUploading=!1,this.hasError=!1}s.prototype.setState=function(e){this.state=e,this.stateCaption=o[e],this.isActive=this.state>i.NEW&&this.state<i.UPLOAD_OK,this.isUploading=this.state===i.UPLOADING,this.hasError=this.state>i.UPLOAD_CANCELED&&this.state<i.NEW,t.log("state",e,this.stateCaption,this)},s.prototype.abort=function(){this.uploadPromise&&this.uploadPromise.abort(),this.setState(i.UPLOAD_CANCELED)};var l={createPymFile:function(t){return new s(t)},upload:function(t,a,n){var o,s={url:r.urls.upload,file:a.file,data:{path:t,overwrite:n},headers:{"content-type":a.file.type}};return o=e.upload(s).error(function(t){a.setState(i.UPLOAD_ERROR),a.validationMessage=t}),a.uploadPromise=o,a.setState(i.UPLOADING),o},validateFiles:function(e,o,s){var l={},u={},h=[];return t.log("fileList to validate",o),angular.forEach(o,function(t){t.state===i.VALIDATING&&h.push({key:t.key,filename:t.file.name,size:t.file.size,mime_type:t.file.type})}),u.path=e,u.files=h,u.overwrite=s,a.post(r.urls.validate_files,u,l).then(function(t){return t.data.ok?angular.forEach(t.data.data,function(t,e){"ok"===t?o[e].setState(i.VALIDATION_OK):(o[e].setState(i.VALIDATION_ERROR),o[e].validationMessage=t)}):(n.growler.growlAjaxResp(t.data),angular.forEach(o,function(t,e){t.state===i.VALIDATING&&(o[e].setState(i.VALIDATION_ERROR),o[e].validationMessage="Unknown error")})),t},function(t){return angular.forEach(o,function(t,e){t.state===i.VALIDATING&&(o[e].setState(i.VALIDATION_ERROR),o[e].validationMessage="Network error")}),t})}};return l}]),angular.module("pym.fs").controller("pymFsUploaderController",["$scope","$window","$log","T","pymService","pymFsService","pymFsUploaderService","FILE_STATES","$q",function(t,e,a,r,n,i,o,s,l){"use strict";var u=this;u.files=[],u.rejectedFiles=[],u.isDropAvailable=null,u.queue={},u.activeUploads=0,u.errors=0,u.uploading=0,u.totalProgress=0,u.windowMaximized=!0,u.windowIsOpen=!1,u.countActiveUploads=function(){var t=0,e=0,a=0,r=0,n=0;angular.forEach(u.queue,function(i){i.isActive&&++t,i.hasError&&++e,i.isUploading&&++a,r+=i.progress,++n}),u.activeUploads=t,u.errors=e,u.uploading=a,0!==n&&(u.totalProgress=parseInt(r/n))},t.$watch(u.countActiveUploads,function(){angular.noop()}),u.minimaxWindow=function(){u.windowMaximized=!u.windowMaximized},u.cancelAll=function(){return u.activeUploads?n.growler.confirm(r.confirm_cancel_all_uploads).then(function(){angular.forEach(u.queue,function(t){t.abort()})}):l.defer().resolve()},u.closeWindow=function(){function t(){u.clearQueue(),u.windowIsOpen=!1}u.activeUploads?u.cancelAll().then(t):t()},u.fileDropped=function(t,e){a.log("dropped",t,this.files,e),t&&t.length>0&&this.enqueue(t)},u.fileSelected=function(t,e){a.log("selected",t,this.files,e),t&&t.length>0&&this.enqueue(t)},u.validate=function(t){return a.log("Validating file",t),"audio/x-ape"!==t.type},u.clearQueue=function(){var t;for(t in u.queue)u.queue.hasOwnProperty(t)&&delete u.queue[t]},u.enqueue=function(t){var e,a,r,n=this,l={};if(t&&t.length>0){for(u.windowIsOpen=!0,e=0,a=t.length;a>e;e++)r=new o.createPymFile(t[e]),n.queue[t[e].name]?(r.setState(s.VALIDATION_ERROR),r.validationMessage="File with this name already in queue",r.key=r.file.name+new Date):(r.setState(s.VALIDATING),n.validateHere(r),r.key=r.file.name),l[r.key]=r,n.queue[r.key]=r;o.validateFiles(i.getPathStr(),l)}},u.validateHere=function(){},u.cbProgress=function(t){var e=parseInt(100*t.loaded/t.total);this.progress=e},u.cbSuccess=function(){this.setState(s.UPLOAD_OK)},u.startUpload=function(){var t,e,r,n=this;angular.forEach(n.queue,function(l){l.state===s.VALIDATION_OK&&(a.log("starting upload of",l.file.name,l),e=angular.bind(l,n.cbProgress),r=angular.bind(l,n.cbSuccess),t=o.upload(i.getPathStr(),l,i.overwrite).progress(e).success(r))})},u.cancel=function(t){t.abort()},u.checkType=function(t){var e,r,n,i,o=this;for(t||(t="application/octet-stream"),t=t.split("/"),a.log(t),i=!1,e=0,r=o.allow.length;r>e;e++)if(n=o.allow[e],n.search(/\*/)>-1&&-1===n.search(/\.\*/)&&(n=n.replace(/\*/g,".*")),n=n.split("/"),t[0].search(n[0])>-1&&t[1].search(n[1])>-1){i=!0;break}if(!i)return!1;for(e=0,r=o.deny.length;r>e;e++)if(n=o.deny[e],n.search(/\*/)>-1&&-1===n.search(/\.\*/)&&(n=n.replace(/\*/g,".*")),n=n.split("/"),t[0].search(n[0])>-1||t[1].search(n[1])>-1){i=!1;break}return i},u.checkSize=function(t){return t>=this.minSize&&t<=this.maxSize}}]);