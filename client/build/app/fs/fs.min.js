angular.module("pym.fs",[]),angular.module("pym.fs").constant("FILE_STATES",{NEW:0,VALIDATING:10,VALIDATION_OK:20,VALIDATION_ERROR:-20,CAN_UPLOAD:70,UPLOADING:80,UPLOAD_OK:90,UPLOAD_ERROR:-90,UPLOAD_CANCELED:-100}).constant("FILE_STATE_CAPTIONS",{0:"New (0)",10:"Validating (10)",20:"Validation OK (20)","-20":"Validation Error (-20)",70:"Can Upload (70)",80:"Uploading (80)",90:"Upload OK (90)","-90":"Upload Error (-90)","-100":"Upload Canceled (-100)"}),angular.module("pym.fs").factory("pymFsService",["$log","$http","$window","RC","pymService",function(t,e,a,r,i){"use strict";var n={tree:null,browser:null,rootPathStr:"",path:[],overwrite:!1,includeDeleted:!1,onUploadFinished:null,refresh:function(){this.tree.refresh(),this.browser.refresh()},getPath:function(){return this.path},getPathStr:function(){return this.pathToStr(this.path)},setPath:function(t){this.path=t,this.tree.setPath(t),this.browser.setPath(t)},getLeafNode:function(){return this.path[this.path.length-1]},toggleIncludeDeleted:function(){var t=this.path,e=t[0];if(this.includeDeleted=!this.includeDeleted,this.getLeafNode().is_deleted&&!this.includeDeleted){for(;t.length&&t[t.length-1].is_deleted;)t.pop();t.length||t.push(e),this.setPath(t)}else this.tree.refresh(),this.browser.refresh()},firstLoad:function(e){var a=this;this.rootPathStr=e,t.log("firstLoad",this.pathToStr(this.path),this.rootPathStr),this.browser.loadItems(),this.tree.initNodes().then(function(){a.path=a.tree.path,a.browser.path=a.path})},extractMeta:function(t){var a={},n={names:t,path:this.pathToStr(this.path)};return e.put(r.urls.extract_meta,n,a).then(function(t){return t.data.ok,i.growler.growlAjaxResp(t.data),t},function(t){return t})},createDirectory:function(t){var a={},n={name:t,path:this.pathToStr(this.path)};return e.post(r.urls.create_directory,n,a).then(function(t){return t.data.ok,i.growler.growlAjaxResp(t.data),t},function(t){return t})},deleteItems:function(t,a){var n={params:{path:this.pathToStr(this.path),names:t,reason:a}};return e["delete"](r.urls.delete_items,n).then(function(t){return t.data.ok,i.growler.growlAjaxResp(t.data),t},function(t){return t})},undeleteItems:function(t){var a={},n={path:this.pathToStr(this.path),names:t};return e.put(r.urls.undelete_items,n,a).then(function(t){return t.data.ok,i.growler.growlAjaxResp(t.data),t},function(t){return t})},loadItems:function(){var t={params:{path:this.pathToStr(this.path)||this.rootPathStr,incdel:this.includeDeleted}};return e.get(r.urls.load_items,t).then(function(t){return t.data.ok||i.growler.growlAjaxResp(t.data),t},function(t){return t})},loadTree:function(t){var a={params:{path:this.rootPathStr,filter:t,incdel:this.includeDeleted}};return e.get(r.urls.load_tree,a).then(function(t){return t.data.ok||i.growler.growlAjaxResp(t.data),t},function(t){return t})},loadFsProperties:function(){var t={params:{}};return e.get(r.urls.load_fs_properties,t).then(function(t){return t.data.ok?t:(i.growler.growlAjaxResp(t.data),!1)},function(t){return t})},loadItemProperties:function(t){var a={params:{path:this.pathToStr(this.path),name:t}};return e.get(r.urls.load_item_properties,a).then(function(t){return t.data.ok?t:(i.growler.growlAjaxResp(t.data),!1)},function(t){return t})},buildDownloadUrl:function(t){var e,r;return e=this.path.slice(),"fs"===e[0].name&&e.shift(),r=e.length?this.pathToStr(e)+"/"+t:t,a.location.href.replace(/@@_br_/,r)},pathToStr:function(t){if(!(angular.isArray(t)&&t.length>0))return null;var e=[];return angular.forEach(t,function(t){e.push(t.name)}),e.join("/")}};return n}]),angular.module("pym.fs").factory("pymFsUploaderService",["$log","$upload","$http","RC","pymService","FILE_STATES","FILE_STATE_CAPTIONS",function(t,e,a,r,i,n,s){"use strict";function o(t){this.file=t,this.state=0,this.stateCaption=null,this.key=null,this.progress=0,this.validationPromise=null,this.validationMessage=null,this.uploadPromise=null,this.isActive=!1,this.isUploading=!1,this.hasError=!1,this.exists=!1,this.permissions=null,this.writeMode=null}o.prototype.setState=function(e){this.state=e,this.stateCaption=s[e],this.isActive=this.state>n.NEW&&this.state<n.UPLOAD_OK,this.isUploading=this.state===n.UPLOADING,this.hasError=this.state>n.UPLOAD_CANCELED&&this.state<n.NEW,t.log("state",e,this.stateCaption,this)},o.prototype.setWriteMode=function(t){this.writeMode=t,this.setState(n.CAN_UPLOAD)},o.prototype.setExistsAndPermissions=function(t,e){this.exists=t,this.permissions=e,!t&&e.create?(this.setWriteMode("create"),this.setState(n.CAN_UPLOAD)):this.setState(n.VALIDATION_OK)},o.prototype.abort=function(){this.uploadPromise&&this.uploadPromise.abort(),this.setState(n.UPLOAD_CANCELED)};var l={createPymFile:function(t){return new o(t)},upload:function(a,s){var o,l={url:r.urls.upload,file:s.file,data:{key:s.key,size:s.file.size,path:a,write_mode:s.writeMode}};return o=e.upload(l).success(function(e){t.log("succ upl",e),e.ok?e.data[s.key].ok?s.setState(n.UPLOAD_OK):(s.setState(n.UPLOAD_ERROR),s.validationMessage=e.data[s.key].validation_msg):(i.growler.growlAjaxResp(e),s.state===n.UPLOADING&&(s.setState(n.UPLOAD_ERROR),s.validationMessage="Unknown error"))}).error(function(t,e){s.setState(n.UPLOAD_ERROR),s.validationMessage=e}),s.uploadPromise=o,s.setState(n.UPLOADING),o},validateFiles:function(e,s){var o={},l={},u=[];return t.log("fileList to validate",s),angular.forEach(s,function(t){t.state===n.VALIDATING&&u.push({key:t.key,filename:t.file.name,size:t.file.size,mime_type:t.file.type})}),l.path=e,l.files=u,a.post(r.urls.validate_files,l,o).then(function(t){return t.data.ok?angular.forEach(t.data.data,function(t,e){t.ok?s[e].setExistsAndPermissions(t.exists,t.permissions):(s[e].setState(n.VALIDATION_ERROR),s[e].validationMessage=t.validation_msg)}):(i.growler.growlAjaxResp(t.data),angular.forEach(s,function(t,e){t.state===n.VALIDATING&&(s[e].setState(n.VALIDATION_ERROR),s[e].validationMessage="Unknown error")})),t},function(t){return angular.forEach(s,function(t,e){t.state===n.VALIDATING&&(s[e].setState(n.VALIDATION_ERROR),s[e].validationMessage="Network error")}),t})}};return l}]),angular.module("pym.fs").controller("pymFsUploaderController",["$scope","$window","$log","T","pymService","pymFsService","pymFsUploaderService","FILE_STATES","$q",function(t,e,a,r,i,n,s,o,l){"use strict";var u=this;u.FILE_STATES=o,u.files=[],u.rejectedFiles=[],u.isDropAvailable=null,u.queue={},u.activeUploads=0,u.errors=0,u.uploading=0,u.totalProgress=0,u.windowMaximized=!0,u.windowIsOpen=!1,u.countActiveUploads=function(){var t=0,e=0,a=0,r=0,i=0;return angular.forEach(u.queue,function(n){n.isActive&&++t,n.hasError&&++e,n.isUploading&&++a,r+=n.progress,++i}),u.activeUploads=t,u.errors=e,u.uploading=a,0!==i&&(u.totalProgress=parseInt(r/i)),u.activeUploads},t.$watch(u.countActiveUploads,function(t,e){0===t&&t!==e&&n.onUploadFinished&&n.onUploadFinished()}),u.minimaxWindow=function(){u.windowMaximized=!u.windowMaximized},u.cancelAll=function(){return u.activeUploads?i.growler.confirm(r.confirm_cancel_all_uploads).then(function(){angular.forEach(u.queue,function(t){t.abort()})}):l.defer().resolve()},u.closeWindow=function(){function t(){u.clearQueue(),u.windowIsOpen=!1}u.activeUploads?u.cancelAll().then(t):t()},u.fileDropped=function(t,e){a.log("dropped",t,this.files,e),t&&t.length>0&&this.enqueue(t)},u.fileSelected=function(t,e){a.log("selected",t,this.files,e),t&&t.length>0&&this.enqueue(t)},u.validate=function(t){return a.log("Validating file",t),"audio/x-ape"!==t.type},u.clearQueue=function(){var t;for(t in u.queue)u.queue.hasOwnProperty(t)&&delete u.queue[t]},u.enqueue=function(t){var e,a,r,i=this,l={};if(t&&t.length>0){for(u.windowIsOpen=!0,e=0,a=t.length;a>e;e++)r=new s.createPymFile(t[e]),i.queue[t[e].name]?(r.setState(o.VALIDATION_ERROR),r.validationMessage="File with this name already in queue",r.key=r.file.name+new Date):(r.setState(o.VALIDATING),i.validateHere(r),r.key=r.file.name),l[r.key]=r,i.queue[r.key]=r;s.validateFiles(n.getPathStr(),l)}},u.validateHere=function(){},u.cbProgress=function(t){var e=parseInt(100*t.loaded/t.total);this.progress=e},u.startUpload=function(){var t,e,r=this;angular.forEach(r.queue,function(i){i.state===o.CAN_UPLOAD&&(a.log("starting upload of",i.file.name,i),e=angular.bind(i,r.cbProgress),t=s.upload(n.getPathStr(),i).progress(e))})},u.cancel=function(t){t.abort()},u.checkType=function(t){var e,r,i,n,s=this;for(t||(t="application/octet-stream"),t=t.split("/"),a.log(t),n=!1,e=0,r=s.allow.length;r>e;e++)if(i=s.allow[e],i.search(/\*/)>-1&&-1===i.search(/\.\*/)&&(i=i.replace(/\*/g,".*")),i=i.split("/"),t[0].search(i[0])>-1&&t[1].search(i[1])>-1){n=!0;break}if(!n)return!1;for(e=0,r=s.deny.length;r>e;e++)if(i=s.deny[e],i.search(/\*/)>-1&&-1===i.search(/\.\*/)&&(i=i.replace(/\*/g,".*")),i=i.split("/"),t[0].search(i[0])>-1||t[1].search(i[1])>-1){n=!1;break}return n},u.checkSize=function(t){return t>=this.minSize&&t<=this.maxSize}}]);