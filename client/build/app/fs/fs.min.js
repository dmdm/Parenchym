angular.module("pym.fs",[]),angular.module("pym.fs").constant("FILE_STATES",{NEW:0,VALIDATING:10,VALIDATION_OK:20,VALIDATION_ERROR:-20,CAN_UPLOAD:70,UPLOADING:80,UPLOAD_OK:90,UPLOAD_ERROR:-90,UPLOAD_CANCELED:-100}).constant("FILE_STATE_CAPTIONS",{0:"New (0)",10:"Validating (10)",20:"Validation OK (20)","-20":"Validation Error (-20)",70:"Can Upload (70)",80:"Uploading (80)",90:"Upload OK (90)","-90":"Upload Error (-90)","-100":"Upload Canceled (-100)"}),angular.module("pym.fs").factory("pymFsService",["$log","$http","$q","$window","RC","pymService",function(t,e,a,r,i,s){"use strict";var n={tree:null,browser:null,rootPathStr:"",path:[],prevPath:[],globalOptions:{includeDeleted:!1,searchArea:"here",searchFields:"name",search:""},onUploadFinished:null,lastSearch:{path:null,incdel:null,sarea:null,sfields:null,s:null},lastSearchResult:null,find:function(){this.globalOptions.search.length&&this.tree.setPathById(-1e3)},refresh:function(){this.tree.refresh(),this.browser.refresh()},getPath:function(){return this.path},getPathStr:function(){return this.pathToStr(this.path)},setPath:function(t){this.path[this.path.length-1].id>0&&(this.prevPath=this.path),this.path=t,this.tree.setPath(t),this.browser.setPath(t)},getLeafNode:function(){return this.path[this.path.length-1]},toggleIncludeDeleted:function(){var t=this.path,e=t[0];if(this.getLeafNode().is_deleted&&!this.globalOptions.includeDeleted){for(;t.length&&t[t.length-1].is_deleted;)t.pop();t.length||t.push(e),this.setPath(t)}else this.tree.refresh(),this.browser.refresh()},firstLoad:function(e){var a=this;this.rootPathStr=e,t.log("firstLoad",this.pathToStr(this.path),this.rootPathStr),this.browser.loadItems(),this.tree.initNodes().then(function(){a.path=a.tree.path,a.browser.path=a.path})},extractMeta:function(t){var a={},r={names:t,path:this.pathToStr(this.path)};return e.put(i.urls.extract_meta,r,a).then(function(t){return t.data.ok,s.growler.growlAjaxResp(t.data),t},function(t){return t})},createDirectory:function(t){var a={},r={name:t,path:this.pathToStr(this.path)};return e.post(i.urls.create_directory,r,a).then(function(t){return t.data.ok,s.growler.growlAjaxResp(t.data),t},function(t){return t})},deleteItems:function(t,a){var r={params:{path:this.pathToStr(this.path),names:t,reason:a}};return e["delete"](i.urls.delete_items,r).then(function(t){return t.data.ok,s.growler.growlAjaxResp(t.data),t},function(t){return t})},undeleteItems:function(t){var a={},r={path:this.pathToStr(this.path),names:t};return e.put(i.urls.undelete_items,r,a).then(function(t){return t.data.ok,s.growler.growlAjaxResp(t.data),t},function(t){return t})},loadItems:function(){var t=this,r={params:{}},n="load",o=this.getLeafNode();if(o&&o.id<=0){if("search"!==o.name)throw new Error("Unknown virtual node: "+o.id);var l,h=this.globalOptions.search.replace(/^\s+/,"").replace(/\s+$/,""),u=this.pathToStr(this.path)||this.rootPathStr;if(n="search",l={path:h.length?u:t.prevPath,incdel:this.globalOptions.includeDeleted,sarea:this.globalOptions.searchArea,sfields:this.globalOptions.searchFields,s:h},angular.equals(l,t.lastSearch)){var c={ok:!0,data:{rows:t.lastSearchResult}},p=a.defer();return p.resolve(c),p.promise}r.params=l}else r.params={path:this.pathToStr(this.path)||this.rootPathStr,incdel:this.globalOptions.includeDeleted,sarea:this.globalOptions.searchArea,sfields:this.globalOptions.searchFields,s:""};return e.get(i.urls.load_items,r).then(function(e){return e.data.data.rows&&"search"===n&&(t.lastSearchResult=e.data.data.rows),e.data.ok||s.growler.growlAjaxResp(e.data),e},function(t){return t})},loadTree:function(t){var a={params:{path:this.rootPathStr,filter:t,incdel:this.globalOptions.includeDeleted}};return e.get(i.urls.load_tree,a).then(function(t){return t.data.ok||s.growler.growlAjaxResp(t.data),t},function(t){return t})},loadFsProperties:function(){var t={params:{}};return e.get(i.urls.load_fs_properties,t).then(function(t){return t.data.ok?t:(s.growler.growlAjaxResp(t.data),!1)},function(t){return t})},loadItemProperties:function(t){var a={params:{path:this.pathToStr(this.path),name:t}};return e.get(i.urls.load_item_properties,a).then(function(t){return t.data.ok?t:(s.growler.growlAjaxResp(t.data),!1)},function(t){return t})},changeItemAttr:function(t,r,n,o){var l={},h={id:t,attr:r,nv:n,ov:o};return e.put(i.urls.edit_item,h,l).then(function(t){return s.growler.growlAjaxResp(t.data),t.data.ok?t:a.reject(t)},function(t){return a.reject(t)})},buildDownloadUrl:function(t){var e,a,i,s,n;return angular.isString(t)?(i=t,e=this.path.slice(),"fs"===e[0].name&&e.shift(),a=e.length?this.pathToStr(e)+"/"+i:i,r.location.href.replace(/@@_br_/,a)):(s=t,n=r.location.pathname.split("/").slice(0,2).join("/"),a=r.location.origin+n+"/"+s.location+"/"+s._name)},pathToStr:function(t){if(!(angular.isArray(t)&&t.length>0))return null;var e=[];return angular.forEach(t,function(t){e.push(t.name)}),e.join("/")}};return n}]),angular.module("pym.fs").factory("pymFsUploaderService",["$log","$upload","$http","RC","pymService","FILE_STATES","FILE_STATE_CAPTIONS",function(t,e,a,r,i,s,n){"use strict";function o(t){this.file=t,this.state=0,this.stateCaption=null,this.key=null,this.progress=0,this.validationPromise=null,this.validationMessage=null,this.uploadPromise=null,this.isActive=!1,this.isUploading=!1,this.hasError=!1,this.exists=!1,this.permissions=null,this.writeMode=null}o.prototype.setState=function(e){this.state=e,this.stateCaption=n[e],this.isActive=this.state>s.NEW&&this.state<s.UPLOAD_OK,this.isUploading=this.state===s.UPLOADING,this.hasError=this.state>s.UPLOAD_CANCELED&&this.state<s.NEW,t.log("state",e,this.stateCaption,this)},o.prototype.setWriteMode=function(t){this.writeMode=t,this.setState(s.CAN_UPLOAD)},o.prototype.setExistsAndPermissions=function(t,e){this.exists=t,this.permissions=e,!t&&e.create?(this.setWriteMode("create"),this.setState(s.CAN_UPLOAD)):this.setState(s.VALIDATION_OK)},o.prototype.abort=function(){this.uploadPromise&&this.uploadPromise.abort(),this.setState(s.UPLOAD_CANCELED)};var l={createPymFile:function(t){return new o(t)},upload:function(a,n){var o,l={url:r.urls.upload,file:n.file,data:{key:n.key,size:n.file.size,path:a,write_mode:n.writeMode}};return o=e.upload(l).success(function(e){t.log("succ upl",e),e.ok?e.data[n.key].ok?n.setState(s.UPLOAD_OK):(n.setState(s.UPLOAD_ERROR),n.validationMessage=e.data[n.key].validation_msg):n.state===s.UPLOADING&&(n.setState(s.UPLOAD_ERROR),n.validationMessage="Unknown error"),i.growler.growlAjaxResp(e,!1)}).error(function(t,e){n.setState(s.UPLOAD_ERROR),n.validationMessage=e}),n.uploadPromise=o,n.setState(s.UPLOADING),o},validateFiles:function(e,n){var o={},l={},h=[];return t.log("fileList to validate",n),angular.forEach(n,function(t){t.state===s.VALIDATING&&h.push({key:t.key,filename:t.file.name,size:t.file.size,mime_type:t.file.type})}),l.path=e,l.files=h,a.post(r.urls.validate_files,l,o).then(function(t){return t.data.ok?angular.forEach(t.data.data,function(t,e){t.ok?n[e].setExistsAndPermissions(t.exists,t.permissions):(n[e].setState(s.VALIDATION_ERROR),n[e].validationMessage=t.validation_msg)}):(i.growler.growlAjaxResp(t.data),angular.forEach(n,function(t,e){t.state===s.VALIDATING&&(n[e].setState(s.VALIDATION_ERROR),n[e].validationMessage="Unknown error")})),t},function(t){return angular.forEach(n,function(t,e){t.state===s.VALIDATING&&(n[e].setState(s.VALIDATION_ERROR),n[e].validationMessage="Network error")}),t})}};return l}]),angular.module("pym.fs").controller("pymFsUploaderController",["$scope","$window","$log","T","pymService","pymFsService","pymFsUploaderService","FILE_STATES","$q",function(t,e,a,r,i,s,n,o,l){"use strict";var h=this;h.FILE_STATES=o,h.files=[],h.rejectedFiles=[],h.isDropAvailable=null,h.queue={},h.activeUploads=0,h.errors=0,h.uploading=0,h.totalProgress=0,h.windowMaximized=!0,h.windowIsOpen=!1,h.countActiveUploads=function(){var t=0,e=0,a=0,r=0,i=0;return angular.forEach(h.queue,function(s){s.isActive&&++t,s.hasError&&++e,s.isUploading&&++a,r+=s.progress,++i}),h.activeUploads=t,h.errors=e,h.uploading=a,0!==i&&(h.totalProgress=parseInt(r/i)),h.activeUploads},t.$watch(h.countActiveUploads,function(t,e){0===t&&t!==e&&s.onUploadFinished&&s.onUploadFinished()}),h.minimaxWindow=function(){h.windowMaximized=!h.windowMaximized},h.cancelAll=function(){return h.activeUploads?i.growler.confirm(r.confirm_cancel_all_uploads).then(function(){angular.forEach(h.queue,function(t){t.abort()})}):l.defer().resolve()},h.closeWindow=function(){function t(){h.clearQueue(),h.windowIsOpen=!1}h.activeUploads?h.cancelAll().then(t):t()},h.fileDropped=function(t,e){a.log("dropped",t,this.files,e),t&&t.length>0&&this.enqueue(t)},h.fileSelected=function(t,e){a.log("selected",t,this.files,e),t&&t.length>0&&this.enqueue(t)},h.validate=function(t){return a.log("Validating file",t),"audio/x-ape"!==t.type},h.clearQueue=function(){var t;for(t in h.queue)h.queue.hasOwnProperty(t)&&delete h.queue[t]},h.enqueue=function(t){var e,a,r,i=this,l={};if(t&&t.length>0){for(h.windowIsOpen=!0,e=0,a=t.length;a>e;e++)r=new n.createPymFile(t[e]),i.queue[t[e].name]?(r.setState(o.VALIDATION_ERROR),r.validationMessage="File with this name already in queue",r.key=r.file.name+new Date):(r.setState(o.VALIDATING),i.validateHere(r),r.key=r.file.name),l[r.key]=r,i.queue[r.key]=r;n.validateFiles(s.getPathStr(),l)}},h.validateHere=function(){},h.cbProgress=function(t){var e=parseInt(100*t.loaded/t.total);this.progress=e},h.startUpload=function(){var t,e,r=this;angular.forEach(r.queue,function(i){i.state===o.CAN_UPLOAD&&(a.log("starting upload of",i.file.name,i),e=angular.bind(i,r.cbProgress),t=n.upload(s.getPathStr(),i).progress(e))})},h.cancel=function(t){t.abort()},h.checkType=function(t){var e,r,i,s,n=this;for(t||(t="application/octet-stream"),t=t.split("/"),a.log(t),s=!1,e=0,r=n.allow.length;r>e;e++)if(i=n.allow[e],i.search(/\*/)>-1&&-1===i.search(/\.\*/)&&(i=i.replace(/\*/g,".*")),i=i.split("/"),t[0].search(i[0])>-1&&t[1].search(i[1])>-1){s=!0;break}if(!s)return!1;for(e=0,r=n.deny.length;r>e;e++)if(i=n.deny[e],i.search(/\*/)>-1&&-1===i.search(/\.\*/)&&(i=i.replace(/\*/g,".*")),i=i.split("/"),t[0].search(i[0])>-1||t[1].search(i[1])>-1){s=!1;break}return s},h.checkSize=function(t){return t>=this.minSize&&t<=this.maxSize}}]);